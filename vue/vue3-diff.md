# ã€æºç ç³»åˆ—#06ã€‘Vue3 Diff ç®—æ³• ğŸŒ¸

[https://www.douyin.com/search/%E5%93%B2%E7%8E%84%E5%89%8D%E7%AB%AF?modal_id=7258902157800246589&type=video]

## å‰åå…ƒç´ ä¸ä¸€è‡´

- ä¸¤ä¸ªä¸åŒè™šæ‹ŸèŠ‚ç‚¹ä¸éœ€è¦è¿›è¡Œæ¯”è¾ƒï¼Œç›´æ¥ç§»é™¤è€çš„èŠ‚ç‚¹ï¼Œç„¶åå°†æ–°çš„èŠ‚ç‚¹æ¸²æŸ“æˆçœŸå®çš„ dom æŒ‚è½½åˆ°é¡µé¢ä¸Š

## å‰åå…ƒç´ ä¸€è‡´

- ä¸¤ä¸ªç›¸åŒçš„è™šæ‹ŸèŠ‚ç‚¹ï¼Œå…ˆå¤ç”¨èŠ‚ç‚¹ï¼Œå†æ¯”è¾ƒä¸¤ä¸ªèŠ‚ç‚¹çš„å±æ€§å’Œå­èŠ‚ç‚¹
  - èƒ½å¤ç”¨å°±å¤ç”¨
  - ç„¶åå†æ–°å¢æˆ–è€…åˆ é™¤
- åˆ¤æ–­æ˜¯å¦æ˜¯ç›¸åŒçš„è™šæ‹ŸèŠ‚ç‚¹ï¼Ÿ
  - åˆ¤æ–­èŠ‚ç‚¹çš„ key æ˜¯å¦ç›¸åŒ
  - åˆ¤æ–­èŠ‚ç‚¹çš„ type æ˜¯å¦ç›¸åŒ

## æ ¸å¿ƒ Diff ç®—æ³•

### åœ¨å¤„ç†æœ‰ key è¿›è¡Œ diff ç®—æ³•æ—¶ï¼Œæˆ‘æŠŠå¯¹æ¯”åˆ†ä¸ºå››ç§æƒ…å†µéœ€è¦å¤„ç†ï¼š

- ä»å‰å¾€åé€’å¢å¯¹æ¯”èŠ‚ç‚¹ç±»å‹å’Œ key ç›¸åŒçš„è¿›è¡Œå¤ç”¨ï¼ˆåœ¨ä¸åŒå¤„åœæ­¢å¯¹æ¯”ï¼‰ã€‚
- ä»åå¾€å‰é€’å‡è¡Œå¯¹æ¯”èŠ‚ç‚¹ç±»å‹å’Œ key ç›¸åŒçš„è¿›è¡Œå¤ç”¨ï¼ˆåœ¨ä¸åŒå¤„åœæ­¢å¯¹æ¯”ï¼‰ã€‚
- æ–°å­çº§æ¯”æ—§å­çº§å¤šï¼Œè¯´æ˜æœ‰æ–°å¢èŠ‚ç‚¹ï¼Œå¦‚æœå°‘è¯´æ˜è¦å¸è½½æŸäº›æ—§èŠ‚ç‚¹ã€‚
- é¦–å°¾ç›¸åŒéƒ½å¯èƒ½ä¼šæœ‰ç›¸åŒèŠ‚ç‚¹ï¼Œé¦–å°¾éƒ½å¯¹æ¯”å®Œï¼Œä¸­é—´éƒ¨åˆ†å¯èƒ½å­˜åœ¨å¯å¤ç”¨ä¹±åºèŠ‚ç‚¹ã€‚

å‰åºæ¯”å¯¹ã€ååºæ¯”å¯¹ã€åŒåºåˆ—åŠ æŒ‚è½½ã€åŒåºåˆ—åŠ å¸è½½çš„ç›®çš„éƒ½æ˜¯ï¼šå°½å¯èƒ½å‡å°‘åé¢ä¹±åºæ¯”å¯¹çš„å…ƒç´  åœ¨æ­£å¼ä»‹ç» diff ç®—æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£å‡ ä¸ªé—®é¢˜

å¦‚ä½•åˆ¤æ–­æ˜¯å¦æ˜¯ç›¸åŒçš„è™šæ‹ŸèŠ‚ç‚¹ï¼Ÿ
ç­”ï¼šè™šæ‹ŸèŠ‚ç‚¹çš„ type ç±»å‹ç›¸åŒ && key ç›¸åŒ å³å¯

c1ã€c2 æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ
ç­”ï¼špatch å¯¹æ¯”å…ƒç´ æ‰“è¡¥ä¸ï¼Œå…ˆå¤ç”¨èŠ‚ç‚¹ã€å†æ¯”è¾ƒå±æ€§ã€æœ€åæ¯”è¾ƒå„¿å­èŠ‚ç‚¹ã€‚c1 æŒ‡çš„æ˜¯æ—§çš„å„¿å­èŠ‚ç‚¹ï¼›c2 æŒ‡çš„æ˜¯æ–°çš„å„¿å­èŠ‚ç‚¹

e1ã€e2 æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ
ç­”ï¼šå°¾æŒ‡é’ˆï¼Œåˆå§‹å€¼åˆ†åˆ«æŒ‡å‘æ–°æ—§å­©å­çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œe1 = c1.length - 1 ï¼›e2 = c2.length - 1

- sync from start å‰åºå¯¹æ¯”
  ä»å¤´éƒ¨å¼€å§‹æ­£åºæ¯”å¯¹ï¼Œå¦‚æœæ˜¯ç›¸åŒçš„è™šæ‹ŸèŠ‚ç‚¹ï¼Œåˆ™è°ƒç”¨ patch å¯¹æ¯”å…ƒç´ æ‰“è¡¥ä¸ï¼ˆå…ˆå¤ç”¨èŠ‚ç‚¹ã€å†æ¯”è¾ƒå±æ€§ã€å†é€’å½’æ¯”è¾ƒå­èŠ‚ç‚¹ï¼‰ï¼Œi++ç»§ç»­ï¼›
  ç»ˆæ­¢æ¡ä»¶ï¼šæ–°æ—§è™šæ‹ŸèŠ‚ç‚¹ä¸ä¸€è‡´ï¼Œæˆ– åŒæ–¹æœ‰ä¸€æ–¹ i å¤§äº å°¾æŒ‡é’ˆï¼Œåœæ­¢å¾ªç¯(i > e1 && i > e2)
  ```
    while (i <= e1 && i <= e2) {  //ä»å¤´å¼€å§‹æ¯”ï¼Œç›¸åŒå°±è¿›è¡Œpatchï¼Œæœ‰ä¸€æ–¹åœæ­¢å¾ªç¯ç›´æ¥è·³å‡º
      const n1 = oldChildren[i]//å–å‡ºæ¯ä¸€ä¸ªè¿›è¡Œæ¯”è¾ƒæ˜¯å¦ç›¸åŒ
      const n2 = newChildren[i]
      if (isSameVnode(n1, n2)) {//æ¯”è¾ƒç±»å‹å’Œkeyï¼Œå¦‚æœç›¸åŒå°±é€’å½’æ¯”è¾ƒä»–ä»¬çš„å­çº§
        //å¯¹æ¯”ä¸¤ä¸ªå…ƒç´ ï¼ˆä¸Šé¢åªæ˜¯ç±»å‹å’Œkeyç›¸åŒï¼Œå¹¶ä¸ä»£è¡¨ä¸¤ä¸ªå…ƒç´ ä¸­å±æ€§æˆ–å­çº§ç›¸åŒï¼‰
        patch(n1, n2, el)
      } else {
        //å½“ä¸¤ä¸ªå…ƒç´ ä¸ç›¸åŒæ—¶å°±åœæ­¢æ¯”è¾ƒï¼Œå› ä¸ºè¦æ›´æ–°å½“å‰çš„æ—§å…ƒç´ 
        break
      }
      i++
    }
  ```
- sync from end ååºå¯¹æ¯”
  ä»å°¾éƒ¨å¼€å§‹å€’åºæ¯”å¯¹ï¼Œå¦‚æœæ˜¯ç›¸åŒçš„è™šæ‹ŸèŠ‚ç‚¹ï¼Œåˆ™è°ƒç”¨ patch å¯¹æ¯”å…ƒç´ æ‰“è¡¥ä¸ï¼ˆå…ˆå¤ç”¨èŠ‚ç‚¹ã€å†æ¯”è¾ƒå±æ€§ã€å†é€’å½’æ¯”è¾ƒå­èŠ‚ç‚¹ï¼‰ï¼Œe1-- e2-- ç»§ç»­ï¼›
  ç»ˆæ­¢æ¡ä»¶ï¼šæ–°æ—§è™šæ‹ŸèŠ‚ç‚¹ä¸ä¸€è‡´ï¼Œæˆ– åŒæ–¹æœ‰ä¸€æ–¹ i å°äº å¤´æŒ‡é’ˆï¼Œåœæ­¢å¾ªç¯(i < e1 && i < e2)
  ```
   while (i <= e1 && i <= e2) {//å†ä»åå¾€å‰æ¯”
    const n1 = oldChildren[e1]//å–å‡ºæœ€åä¸€ä¸ª
    const n2 = newChildren[e2]
    if (isSameVnode(n1, n2)) {//æ¯”è¾ƒç±»å‹å’Œkeyï¼Œå¦‚æœç›¸åŒå°±é€’å½’æ¯”è¾ƒä»–ä»¬çš„å­çº§
      patch(n1, n2, el)
    } else {
      //å½“ä¸¤ä¸ªå…ƒç´ ä¸ç›¸åŒæ—¶å°±åœæ­¢æ¯”è¾ƒï¼Œå› ä¸ºè¦æ›´æ–°å½“å‰çš„æ—§å…ƒç´ 
      break
    }
    e1--
    e2--
  }
  ```
- common sequence+mount åŒåºåˆ—åŠ æŒ‚è½½
  åˆ†ä¸º å¤´éƒ¨æŒ‚è½½ å’Œ å°¾éƒ¨æŒ‚è½½ ä¸¤ç§åœºæ™¯
  i æ¯” e1 å¤§è¯´æ˜æœ‰è¦æ–°å¢çš„ï¼Œi å’Œ e2 ä¹‹é—´çš„æ˜¯æ–°å¢çš„èŠ‚ç‚¹

  ```
    // common sequence + mount åŒåºåˆ—åŠ æŒ‚è½½
    // iè¦æ¯”e1å¤§è¯´æ˜æœ‰æ–°å¢çš„ï¼›iå’Œe2ä¹‹é—´çš„æ˜¯æ–°å¢çš„éƒ¨åˆ†
    // (a b c)
    // (a b c) d e
    //     (a b c)
    // e d (a b c)
    if (i > e1) {
      if (i <= e2) {
        while (i <= e2) {
          const nextPos = e2 + 1
          // æ ¹æ®ä¸‹ä¸€ä¸ªäººçš„ç´¢å¼•æ¥çœ‹å‚ç…§ç‰©
          const anchor = nextPos < c2.length ? c2[nextPos].el : null
          patch(null, c2[i], container, anchor) // åˆ›å»ºæ–°èŠ‚ç‚¹ æ‰”åˆ°å®¹å™¨ä¸­
          i++
        }
      }
    }

  ```

- common sequence+unmount åŒåºåˆ—åŠ å¸è½½
  åˆ†ä¸º å¤´éƒ¨å¸è½½ å’Œ å°¾éƒ¨å¸è½½ ä¸¤ç§åœºæ™¯
  i æ¯” e2 å¤§è¯´æ˜æœ‰è¦å¸è½½çš„ï¼Œi åˆ° e1 ä¹‹é—´çš„å°±æ˜¯è¦å¸è½½çš„èŠ‚ç‚¹

  ```
    // common sequence + unmount åŒåºåˆ—åŠ å¸è½½
    // iæ¯”e2å¤§è¯´æ˜æœ‰è¦å¸è½½çš„ï¼›iåˆ°e1ä¹‹é—´çš„å°±æ˜¯è¦å¸è½½çš„
    // (a b c) d e
    // (a b c)
    // e d (a b c)
    //     (a b c)
    else if (i > e2) {
      if (i <= e1) {
        while (i <= e1) {
          unmount(c1[i])
          i++
        }
      }
    }
  ```

  å‰åºæ¯”å¯¹ã€ååºæ¯”å¯¹ã€åŒåºåˆ—åŠ æŒ‚è½½ã€åŒåºåˆ—åŠ å¸è½½çš„ç›®çš„éƒ½æ˜¯ï¼šå°½å¯èƒ½å‡å°‘åé¢ä¹±åºæ¯”å¯¹çš„å…ƒç´ 

- unknown sequence ä¹±åºå¯¹æ¯”
  å‰åå¯¹æ¯”å®Œåï¼Œä¸­é—´å°±å‰©ä¹±åºçš„å­çº§ï¼Œè¦åœ¨å½“ä¸­æ‰¾å‡ºå“ªäº›å¯ä»¥å¤ç”¨ï¼Œä¸èƒ½å¤ç”¨å°±è¦åˆ é™¤æ‰ï¼Œæ–°å¢çš„å­çº§å°±åˆ›å»ºå…ƒç´ å¹¶æ’å…¥

  ```
    (a b) c d e   (f g)
    (a b) e c d h (f g)
    ä»ä¸Šå›¾å¯çœ‹å‡ºCDEéƒ½å¯è¿›è¡Œå¤ç”¨ï¼Œåªéœ€è¦å¯¹hè¿›è¡Œæ–°å¢ï¼›
    ä¸‹é¢ä¼šæŠŠæ—§å­çº§ä¸­[C,D,E]ç§°ä¸ºæ—§ä¹±åºå­çº§ï¼ˆåˆ—è¡¨ï¼‰ï¼Œæ–°å­çº§ä¸­[E,C,D,H]ç§°ä¸ºæ–°ä¹±åºå­çº§ï¼ˆåˆ—è¡¨ï¼‰
  ```

  - æ€è·¯ï¼š
    - æ–°å¢ s1 å’Œ s2 æŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘åœ¨ i åœæ­¢çš„ä½ç½®
    - æŠŠæ–°å­çº§çš„æ‰€æœ‰ä¹±åºå…ƒç´ ï¼ˆECDHï¼‰ä¿å­˜åœ¨ä¸€ä¸ªæ˜ å°„è¡¨é‡Œï¼ˆkeyToNewIndexMapï¼‰[{'E' : 2}, {'C': 3},{ 'D' : 4}, {'H' : 5}]
    - éå†æ—§ä¹±åºå­çº§ï¼ŒæŸ¥æ‰¾æ˜ å°„è¡¨ä¸­æ˜¯å¦å­˜åœ¨è¯¥å…ƒç´ ï¼Œå­˜åœ¨å°±è¿›è¡Œå¤ç”¨ï¼Œä¸å­˜åœ¨å°±è¯´æ˜éœ€è¦åˆ›å»ºæ–°å…ƒç´ å¹¶æ’å…¥ï¼Œè¿˜è¦æŠŠæ—§èŠ‚ç‚¹è¿›è¡Œåˆ é™¤
    - æ–°å¢ toBePatched å±æ€§ä¿å­˜æ–°ä¹±åºå­çº§çš„ä¸ªæ•°ï¼Œè¿›è¡Œå€’å™æ’å…¥ï¼ˆæ‰¾å‡ºå½“å‰å…ƒç´ çš„ä¸‹ä¸€ä¸ªå…ƒç´ èŠ‚ç‚¹ä½œä¸ºå‚ç…§ç‰©æ’åˆ°å…¶å‰é¢ï¼Œå¦‚æœæ²¡æœ‰ç›´æ¥æ’å…¥æœ€åé¢å³å¯ï¼‰
    - æ–°å¢ newIndexToOldIndexMap å±æ€§ï¼Œä»¥ toBePatched ä¸ºé•¿åº¦çš„æ•°ç»„ï¼Œå¹¶è®¾ç½®é»˜è®¤å€¼ä¸º 0ï¼Œ[0,0,0,0]ï¼Œå¯¹æ—§ä¹±åºå­çº§å¾ªç¯æŸ¥æ‰¾å¯å¤ç”¨èŠ‚ç‚¹ä¸­ï¼Œå¦‚æœå­˜åœ¨å°±ä¼šè¿›è¡Œ patch çš„åŒæ—¶å¹¶è¿›è¡Œæ ‡è¯†ï¼Œå¯ä»¥ç†è§£ä¸ºå¯¹ patch è¿‡çš„æ–°è™šæ‹Ÿ DOM è¿›è¡Œæ ‡è¯†ï¼ˆå› ä¸ºå¯ä»¥å¤ç”¨æ—§è™šæ‹Ÿ DOM ä¿å­˜å¥½çš„çœŸå®èŠ‚ç‚¹ï¼‰ï¼Œåœ¨è¿›è¡Œç§»åŠ¨ä½ç½®æ—¶å°±å¯ä»¥åˆ¤æ–­ï¼Œå¦‚æœè¿˜æ˜¯ä¸º 0 çš„å°±æ˜¯éœ€è¦åˆ›å»ºçœŸå®èŠ‚ç‚¹çš„
  - ä»£ç ï¼š

  ```
    //-----ä¹±åºæ¯”å¯¹-----
    //ä»¥ä¸‹è¦åˆ¤æ–­æ— åºçš„å¯ä»¥å¤ç”¨æƒ…å†µ å¦‚iåˆ°e1å’Œåˆ°e2ä¹‹é—´çš„éƒ½ç§°ä¸ºä¹±åº
    let s1 = i
    let s2 = i
    const keyToNewIndexMap = new Map()//ç”¨äºä¿å­˜ä¹±åºçš„æ–°å­çº§ä¸­çš„å…ƒç´ çš„ä¸‹æ ‡
    for (let i = s2; i <= e2; i++) {//æ³¨æ„iæ˜¯ä»s2å¼€å§‹
      keyToNewIndexMap.set(newChildren[i].key, i)
    }
    //console.log(keyToNewIndexMap);//[{'E' : 2}, {'C': 3},{ 'D' : 4}, {'H' : 5}]

    //å¾ªç¯ä¹±åºæ—§å­çº§ï¼Œçœ‹çœ‹æ–°å­çº§å­˜ä¸å­˜åœ¨è¯¥å…ƒç´ ï¼Œå­˜åœ¨å°±æ·»åŠ åˆ°åˆ—è¡¨ä¸­å¤ç”¨ï¼Œå¦åˆ™åˆ é™¤
    const toBePatched = e2 - s2 + 1 //æ–°ä¹±åºæ€»ä¸ªæ•°
    //æ ¹æ®ä¹±åºä¸ªæ•°åˆ›å»ºæ•°ç»„å¹¶èµ‹å€¼ä¸º0ï¼Œè®°å½•æ˜¯å¦æ¯”å¯¹è¿‡æ˜ å°„è¡¨
    const newIndexToOldIndexMap = new Array(toBePatched).fill(0)//[0,0,0,0]
    for (let i = s1; i <= e1; i++) {//å¾ªç¯æ—§ä¹±åºå­çº§
      const oldchild = oldChildren[i]//æ ¹æ®ä¸‹æ ‡è·å–åˆ°æ—§ä¹±åºä¸­çš„å…ƒç´ 
      //æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨è¯¥å…ƒç´ ï¼Œé‡Œé¢ä¿å­˜çš„æ˜¯å¯¹åº”å…ƒç´ åœ¨newChildrençš„ä¸‹æ ‡
      let newIndex = keyToNewIndexMap.get(oldchild.key)
      if (newIndex == undefined) {
        unmount(oldchild)//å¤šä½™çš„åˆ æ‰
      } else {
        newIndexToOldIndexMap[newIndex - s2] = i + 1 //æ ‡è¯†
        patch(oldchild, newChildren[newIndex], el)//å¦‚æœå­˜åœ¨å°±æ¯”å¯¹å­çº§å·®å¼‚
      }

    }//åˆ°è¿™åªæ˜¯æ–°æ—§æ¯”å¯¹ï¼Œæ²¡æœ‰ç§»åŠ¨ä½ç½®

    //console.log(keyToNewIndexMap);//[{'E' : 2}, {'C': 3},{ 'D' : 4}, {'H' : 5}]
    //console.log(newIndexToOldIndexMap);//[5, 3, 4, 0]

    //éœ€è¦ç§»åŠ¨ä½ç½®
    for (let i = toBePatched - 1; i >= 0; i--) {//å€’å™æ’å…¥
      let index = i + s2 //æ‰¾åˆ°å½“å‰å…ƒç´ åœ¨newChildrenä¸­çš„ä¸‹æ ‡
      let current = newChildren[index] //æ‰¾åˆ°newChildrenæœ€åä¸€ä¸ªä¹±åºå…ƒç´ 
      //æ‰¾åˆ°å…ƒç´ çš„ä¸‹ä¸ªå…ƒç´ ä½œä¸ºå‚ç…§ç‰©
      let anchor = index + 1 < newChildren.length ? newChildren[index + 1] : null
      //currentå¯èƒ½æ˜¯æ–°å¢çš„å…ƒç´ æ²¡æœ‰elï¼Œå¦‚æœæ²¡æœ‰el
      if (newIndexToOldIndexMap[i] === 0) {
        patch(null, current, el, anchor)//ç¬¬ä¸€ä¸ªå…ƒç´ ä¼ å…¥nullï¼Œè¡¨ç¤ºè¦åˆ›å»ºå…ƒç´ å¹¶æ ¹æ®å‚ç…§ç‰©æ’å…¥
      } else {
        hostInsert(current.el, el, anchor.el)//å­˜åœ¨elç›´æ¥æ ¹æ®å‚ç…§ç‰©æ’å…¥
      }
    }
  ```

  ```
    ä¼˜åŒ–çš„åŠæ³•æ˜¯å…ˆéå†æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹ï¼Œæ ¹æ®å­èŠ‚ç‚¹çš„ä½ç½®å’Œ key ç”Ÿæˆä¸€å¼ ç´¢å¼•è¡¨ï¼Œç„¶åå†éå†æ—§çš„ä¸€ç»„å­èŠ‚ç‚¹ï¼Œåˆ©ç”¨èŠ‚ç‚¹çš„ key åœ¨ç´¢å¼•è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„æ–°å­èŠ‚ç‚¹çš„ä½ç½®ï¼Œä»¥æ­¤å¡«å…… source æ•°ç»„ã€‚
    const oldStart = j
    const newStart = j
    const keyIndex = {}
    for(let i = newStart; i <= newEnd; i++) {
        keyIndex[newChildren[i].key] = i
    }
    for(let i = oldStart; i <= oldEnd; i++) {
      oldVNode = oldChildren[i]
      const k = keyIndex[oldVNode.key]
      if (typeof k !== 'undefined') {
        newVNode = newChildren[k]
        patch(oldVNode, newVNode, container)
        source[k - newStart] = i
      } else {
        unmount(oldVNode)
      }
    }
    é¦–å…ˆå°†é¢„å¤„ç†ä¹‹åçš„jå€¼ä½œä¸ºéå†æ–°æ—§èŠ‚ç‚¹å¼€å§‹æ—¶çš„ç´¢å¼•ï¼Œå®šä¹‰ä¸€ä¸ªå¯¹è±¡keyIndexä½œä¸ºç´¢å¼•è¡¨ï¼Œéå†é¢„å¤„ç†ä¹‹åå‰©ä½™çš„ä¸€ç»„æ–°å­èŠ‚ç‚¹ï¼Œå°†æ–°å­èŠ‚ç‚¹newChildren[i]çš„keyå€¼ä¸å…¶ä½ç½®ç´¢å¼•æ”¾å…¥ç´¢å¼•è¡¨ä¸­ã€‚
    éå†æ—§å­èŠ‚ç‚¹ï¼Œåœ¨éå†æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å½“å‰èŠ‚ç‚¹çš„keyå»keyIndexç´¢å¼•è¡¨ä¸­è·å–ä»è€Œæ‹¿åˆ°å½“å‰éå†çš„æ—§å­èŠ‚ç‚¹çš„oldChildren[i]å¯¹åº”çš„æ–°èŠ‚ç‚¹çš„ä½ç½®keyIndex[oldVNode.key],å¦‚æœä½ç½®å­˜åœ¨ï¼Œè¯´æ˜èŠ‚ç‚¹å¯å¤ç”¨ï¼Œä½¿ç”¨patchæ‰“è¡¥ä¸ï¼Œå¹¶ä¸”ä½¿ç”¨å½“å‰æ—§èŠ‚ç‚¹çš„ç´¢å¼•iå¯¹sourceæ•°ç»„è¿›è¡Œå¡«å……ã€‚
  ```

  ç»è¿‡ä¸Šè¿°ä¸€ç•ªä¹±åºå¯¹æ¯”ä¹‹åï¼Œè¦å€’åºéå†æ–°çš„ä¹±åºèŠ‚ç‚¹ï¼Œå¯¹æ¯ä¸ªèŠ‚ç‚¹éƒ½è¿›è¡Œæ“ä½œï¼Œä¼šæœ‰ç‚¹å„¿æµªè´¹æ€§èƒ½ï¼Œèƒ½ä¸èƒ½å°½å¯èƒ½å°‘çš„ç§»åŠ¨èŠ‚ç‚¹ä½ç½®ï¼Œæœ‰ä¿è¯èŠ‚ç‚¹é¡ºåºæ­£ç¡®å‘¢ï¼Ÿ
  ä¾‹å¦‚æ—§èŠ‚ç‚¹ 1, 3, 4, 2ï¼Œæ–°èŠ‚ç‚¹ 1, 2, 3, 4ã€‚é‚£æˆ‘ä»¬å®Œå…¨å¯ä»¥åªå°† 2 ç§»åŠ¨åˆ° 3 å‰é¢ï¼Œåªéœ€ç§»åŠ¨ä¸€æ¬¡ï¼å°±èƒ½ä¿è¯é¡ºåºæ˜¯æ­£ç¡®çš„ï¼ï¼ï¼
  æˆ‘ä»¬å¯ä»¥é’ˆå¯¹äºä¹±åºæ¯”å¯¹ä¸­ç”Ÿæˆçš„æ•°ç»„ newIndexToOldIndexMap è·å–æœ€é•¿é€’å¢å­åºåˆ—
  æœ€é•¿é€’å¢å­åºåˆ—çš„æ„ä¹‰ï¼šé€šè¿‡æœ€é•¿é€’å¢å­åºåˆ—å¾—åˆ°çš„ç´¢å¼•å¯ä»¥æç¤ºæˆ‘ä»¬å“ªäº›å…ƒç´ çš„ç›¸å¯¹ä½ç½®ï¼Œåœ¨å­èŠ‚ç‚¹æ›´æ–°åå¹¶æœªå‘ç”Ÿå˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥ä¿ç•™è¿™äº›èŠ‚ç‚¹çš„ç›¸å¯¹ä½ç½®ï¼Œç„¶åå»å¤„ç†å’Œç§»åŠ¨å…¶ä»–ä½ç½®ã€‚

![](./æœ€é•¿é€’å¢å­åºåˆ—.png)

```
  æ ¹æ®æœ€é•¿é€’å¢å­åºåˆ—ç§»åŠ¨èŠ‚ç‚¹ï¼š
  åˆ›å»ºä¸¤ä¸ªç´¢å¼•è¾…åŠ©ç§»åŠ¨:
  ç´¢å¼• i æŒ‡å‘æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹ä¸­çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ã€‚
  ç´¢å¼• s æŒ‡å‘æœ€é•¿é€’å¢å­åºåˆ—ä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚
  æˆ‘ä»¬éœ€è¦å»åˆ¤æ–­ä»¥ä¸‹çš„æƒ…å†µ:
    source[i] === -1: èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œéœ€è¦æŒ‚è½½æ–°èŠ‚ç‚¹
    i!==seq[s]ï¼šèŠ‚ç‚¹éœ€è¦ç§»åŠ¨ï¼Œ
    i===seq[s]ï¼šèŠ‚ç‚¹æ— éœ€ç§»åŠ¨ï¼Œå°†sé€’å‡å¹¶å†æ¬¡è¿›è¡Œæ¯”è¾ƒ
    å®Œå–„patchKeyedChildrenå»å¤„ç†è¿™å‡ ç§æƒ…å†µ:
    function patchKeyedChildren(n1, n2, container) {
      //çœç•¥é¢„å¤„ç†å’Œæ„é€ sourceæ•°ç»„ä»£ç 
      if (moved) {
        const seq = lis(source)
        // s æŒ‡å‘æœ€é•¿é€’å¢å­åºåˆ—çš„æœ€åä¸€ä¸ªå€¼
        let s = seq.length - 1
        let i = count - 1
        for (i; i >= 0; i--) {
          if (source[i] === -1) {
            // è¯´æ˜ç´¢å¼•ä¸º i çš„èŠ‚ç‚¹æ˜¯å…¨æ–°çš„èŠ‚ç‚¹ï¼Œåº”è¯¥å°†å…¶æŒ‚è½½
            // è¯¥èŠ‚ç‚¹åœ¨æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹ä¸­çš„çœŸå®ä½ç½®ç´¢å¼•
                const pos = i + newStart
                const newVNode = newChildren[pos]
                // è¯¥èŠ‚ç‚¹ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ä½ç½®ç´¢å¼•
                const nextPos = pos + 1
                // é”šç‚¹
                const anchor = nextPos < newChildren.length
                  ? newChildren[nextPos].el
                  : null
                patch(null, newVNode, container, anchor)
          } else if (i !== seq[j]) {

            // è¯´æ˜è¯¥èŠ‚ç‚¹éœ€è¦ç§»åŠ¨
            // è¯¥èŠ‚ç‚¹åœ¨æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹ä¸­çš„çœŸå®ä½ç½®ç´¢å¼•
            const pos = i + newStart
            const newVNode = newChildren[pos]
            // è¯¥èŠ‚ç‚¹ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ä½ç½®ç´¢å¼•
            const nextPos = pos + 1
            // é”šç‚¹
            const anchor = nextPos < newChildren.length
              ? newChildren[nextPos].el
              : null
            patch(null, newVNode, container, anchor)
          } else {
            // å½“ i === seq[j] æ—¶ï¼Œè¯´æ˜è¯¥ä½ç½®çš„èŠ‚ç‚¹ä¸éœ€è¦ç§»åŠ¨
            // å¹¶è®© s æŒ‡å‘ä¸‹ä¸€ä¸ªä½ç½®
            s--
          }
        }
      }
    }
    }


```

```
å®˜æ–¹ï¼š
  å¦‚æœä¸ä½¿ç”¨keyï¼ŒVueä¼šä½¿ç”¨ä¸€ç§æœ€å¤§é™åº¦å‡å°‘åŠ¨æ€å…ƒç´ å¹¶ä¸”å°½å¯èƒ½çš„å°è¯•å°±åœ°ä¿®æ”¹/å¤ç”¨ç›¸åŒç±»å‹å…ƒç´ çš„ç®—æ³•;
  ï¼ˆæ„æ€åº”è¯¥æ˜¯ï¼šæ¯”å¦‚ä¸¤ä¸ªliå…ƒç´ ï¼Œåªæ˜¯å†…å®¹ä¸åŒï¼Œå°è¯•ä¿®æ”¹å†…å®¹åå¤ç”¨è¯¥èŠ‚ç‚¹ï¼›å› ä¸ºæ–°å­çº§çš„è™šæ‹ŸDOMä¸­æ˜¯æ²¡æœ‰ä¿å­˜çœŸå®elèŠ‚ç‚¹çš„ï¼Œéœ€è¦æ ¹æ®æ ‡ç­¾ååˆ›å»ºå…ƒç´ èŠ‚ç‚¹å†è¿›è¡ŒæŒ‚è½½ï¼‰
  è€Œä½¿ç”¨keyæ—¶ï¼Œå®ƒä¼šåŸºäºkeyçš„å˜åŒ–é‡æ–°æ’åˆ—å…ƒç´ é¡ºåºï¼Œå¹¶ä¸”ä¼šç§»é™¤/é”€æ¯keyä¸å­˜åœ¨çš„å…ƒç´ ;
```
